name: Deploy (backend + database)

on:
  push:
    branches:
      - main

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect changed paths
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      database: ${{ steps.filter.outputs.database }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Paths filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
            database:
              - 'database/**'

  deploy_database:
    name: Deploy database schema
    needs: changes
    if: needs.changes.outputs.database == 'true'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install psql client
        run: sudo apt-get update; sudo apt-get install -y postgresql-client

      - name: Check secrets
        env:
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
        run: |
          echo "Checking deployment secrets..."
          if [ -z "$DATABASE_URL" ]; then
            echo "❌ PROD_DATABASE_URL secret is not set"
          else
            echo "✅ PROD_DATABASE_URL secret is set"
          fi

      - name: Apply schema (deploy-safe)
        env:
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "PROD_DATABASE_URL is not set; skipping DB deploy."
            exit 0
          fi
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -f database/schema.deploy.sql

  deploy_backend:
    name: Deploy backend
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Check secrets
        env:
          VERCEL_DEPLOY_HOOK: ${{ secrets.VERCEL_DEPLOY_HOOK }}
        run: |
          echo "Checking deployment secrets..."
          if [ -z "$VERCEL_DEPLOY_HOOK" ]; then
            echo "❌ VERCEL_DEPLOY_HOOK secret is not set"
          else
            echo "✅ VERCEL_DEPLOY_HOOK secret is set"
          fi

      - name: Trigger Vercel deploy hook (optional)
        env:
          VERCEL_DEPLOY_HOOK: ${{ secrets.VERCEL_DEPLOY_HOOK }}
        run: |
          if [ -z "$VERCEL_DEPLOY_HOOK" ]; then
            echo "VERCEL_DEPLOY_HOOK is not set; skipping backend deploy."
            exit 0
          fi
          curl -fsSL -X POST "$VERCEL_DEPLOY_HOOK"
